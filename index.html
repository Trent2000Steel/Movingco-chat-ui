<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MovingCo Concierge</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
    }
    #chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }
    .message {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 12px;
      line-height: 1.4;
    }
    .user {
      background: #0077cc;
      color: white;
      align-self: flex-end;
    }
    .bot {
      background: #e0e0e0;
      color: black;
      align-self: flex-start;
    }
    #input-container {
      display: flex;
      padding: 10px;
      background: #fff;
    }
    #input {
      flex: 1;
      padding: 10px;
      font-size: 1em;
    }
    #send {
      padding: 10px 20px;
      font-size: 1em;
      background: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="chat"></div>
  <div id="input-container">
    <input type="text" id="input" placeholder="Ask about your move..." />
    <button id="send">Send</button>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const send = document.getElementById('send');

    let messages = [
      {
        role: "system",
        content: `You are a calm, confident moving concierge for MovingCo. You guide people through long-distance moves using the MoveSafe Method™.

Your tone is friendly, efficient, and professional. Ask only what’s needed to build a fast, accurate quote.

Collect in this order:
1. Move origin (city)
2. Destination
3. Move size
4. Move date/timing
5. Load/unload help
6. Special/fragile items

DO NOT generate a quote until the user has answered all of the above. When it's time to quote, reply with ONLY the quote and what's included. Keep it brief. The frontend will handle the trust-building messages.`
      }
    ];

    let awaitingQuote = false;

    const addMessage = (text, sender) => {
      const msg = document.createElement('div');
      msg.className = `message ${sender}`;
      msg.textContent = text;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    };

    const sendQuoteRequest = async () => {
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });

        const data = await response.json();
        const quoteReply = data.reply || "[No reply]";
        addMessage(quoteReply, 'bot');
        messages.push({ role: 'assistant', content: quoteReply });
        awaitingQuote = false;
      } catch (err) {
        addMessage("[Error getting quote. Please try again.]", 'bot');
      }
    };

    const simulateTrustSequence = () => {
      const steps = [
        "Scanning route corridors and pricing history...",
        "Filtering movers with 4.5 stars and higher...",
        "Analyzing similar moves from the last 90 days..."
      ];

      steps.forEach((line, index) => {
        setTimeout(() => {
          addMessage(line, 'bot');
        }, index * 1200);
      });

      // Trigger the actual quote after the last delay
      setTimeout(() => {
        sendQuoteRequest();
      }, steps.length * 1200 + 1000);
    };

    const sendMessage = async () => {
      const userMessage = input.value.trim();
      if (!userMessage) return;

      addMessage(userMessage, 'user');
      messages.push({ role: 'user', content: userMessage });
      input.value = '';

      if (awaitingQuote) {
        simulateTrustSequence();
        return;
      }

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });

        const data = await response.json();
        const reply = data.reply || "[No reply]";
        addMessage(reply, 'bot');
        messages.push({ role: 'assistant', content: reply });

        if (
          reply.toLowerCase().includes("special item") ||
          reply.toLowerCase().includes("fragile item")
        ) {
          awaitingQuote = true;
        }
      } catch (err) {
        addMessage("[Error sending message]", 'bot');
      }
    };

    send.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    window.addEventListener('DOMContentLoaded', () => {
      addMessage("No forms, no waiting—I’ll give you a real price range right here in chat.", 'bot');
      setTimeout(() => {
        addMessage("What city are you moving from?", 'bot');
      }, 1500);
    });
  </script>
<footer style="text-align: center; font-size: 0.9em; padding: 15px; background: #f0f0f0; border-top: 1px solid #ccc;">
  <a href="/terms.html" style="margin: 0 10px; color: #555; text-decoration: none;">Terms of Service</a>
  |
  <a href="/privacy.html" style="margin: 0 10px; color: #555; text-decoration: none;">Privacy Policy</a>
</footer>
</body>
</html>
